"<!DOCTYPE html>
<html lang=""th"">
<head>
    <meta charset=""UTF-8"">
    <meta name=""viewport"" content=""width=device-width, initial-scale=1.0"">
    <title>‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ï‡∏≠‡∏ö‡πÅ‡∏ö‡∏ö‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°</title>
    <!-- 1. ‡πÄ‡∏û‡∏¥‡πà‡∏° LIFF SDK -->
    <script charset=""utf-8"" src=""https://static.line-scdn.net/liff/edge/2/sdk.js""></script>
    <link href=""https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Sarabun:wght@400;500;700&display=swap"" rel=""stylesheet"">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #F7F7F7;
            color: #333333;
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            min-height: 600px;
            position: relative;
        }
        .header {
            background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%);
            color: white;
            padding: 40px 30px;
            text-align: center;
        }
        .header h1 {
            font-family: 'Poppins', sans-serif;
            font-size: 2.5rem;
            font-weight: 700;
            margin: 0;
        }
        .content {
            padding: 40px 30px;
        }
        .page { display: none; animation: fadeIn 0.3s ease-in-out; }
        .page.active { display: block; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .instruction-box {
            background: #F1F5F9;
            border: 1px solid #E2E8F0;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 32px;
            border-left: 4px solid #3B82F6;
        }
        .instruction-box p {
            margin: 0;
            color: #475569;
            font-size: 1rem;
        }
        .form-group { margin-bottom: 24px; }
        .form-label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            color: #374151;
            font-size: 1.1rem;
            white-space: pre-wrap;
            word-break: break-word;
        }
        .dropdown select {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #E5E7EB;
            border-radius: 8px;
            font-size: 1rem;
            background: white;
            color: #374151;
            cursor: pointer;
            transition: all 0.3s ease;
            appearance: none;
            background-image: url(""data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e"");
            background-position: right 12px center;
            background-repeat: no-repeat;
            background-size: 16px;
            padding-right: 40px;
        }
        .dropdown select:focus {
            outline: none;
            border-color: #3B82F6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .btn {
            padding: 14px 32px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            font-family: 'Sarabun', sans-serif;
        }
        .btn:disabled {
            background-color: #9CA3AF;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }
        .btn-primary {
            background: #3B82F6;
            color: white;
            width: 100%;
        }
        .btn-primary:hover:not(:disabled) {
            background: #2563EB;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        .btn-success {
            background: #16A34A;
            color: white;
            width: 100%;
        }
        .btn-success:hover:not(:disabled) {
            background: #15803D;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(22, 163, 74, 0.3);
        }
        .btn-back {
            background: transparent;
            color: #6B7280;
            padding: 8px 16px;
            font-size: 0.9rem;
            margin-bottom: 24px;
            border: 1px solid #E5E7EB;
            width: auto;
        }
        .btn-back:hover {
            background: #F9FAFB;
            color: #374151;
        }
        /* Styles for Login Section */
        .btn-line-login {
            background-color: #06C755;
            color: white;
            width: 100%;
            margin-bottom: 16px;
        }
        .btn-line-login:hover {
            background-color: #05b34c;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(6, 199, 85, 0.3);
        }
        .btn-guest {
            background-color: transparent;
            color: #6B7280;
            border: 1px solid #E5E7EB;
            width: 100%;
        }
        .btn-guest:hover {
            background-color: #F9FAFB;
        }

        .problem-statement {
            border: 1px solid #E5E7EB;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 32px;
            background: #FAFAFA;
        }
        .problem-statement h3 {
            font-family: 'Poppins', sans-serif;
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 16px;
            color: #1F2937;
        }
        
        #problem-description {
            white-space: pre-wrap;
            word-break: break-word;
        }

        .image-gallery {
            display: grid;
            grid-template-columns: 1fr;
            gap: 24px;
            margin-top: 24px;
        }
        .image-gallery img {
             width: 100%;
             height: auto;
             border-radius: 8px;
             background-color: #f3f4f6;
             object-fit: cover;
             border: 1px solid #e5e7eb;
        }
        .image-caption {
            font-style: italic;
            font-size: 0.875rem;
            color: #6B7280;
            margin-top: 8px;
            text-align: left;
        }
        .textarea {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #E5E7EB;
            border-radius: 8px;
            font-size: 1rem;
            font-family: 'Sarabun', sans-serif;
            resize: vertical;
            min-height: 100px;
            transition: all 0.3s ease;
        }
        .textarea:focus {
            outline: none;
            border-color: #3B82F6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
         .spinner {
            border: 4px solid rgba(0,0,0,.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #3B82F6;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Custom Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .modal-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            transform: translateY(20px);
            transition: transform 0.3s ease;
        }
        .modal-overlay.active .modal-content {
            transform: translateY(0);
        }
        .modal-title {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 10px;
            color: #1F2937;
        }
        .modal-message {
            color: #4B5563;
            margin-bottom: 20px;
            white-space: pre-wrap;
            text-align: left;
        }
        .modal-btn {
            background: #3B82F6;
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            width: 100%;
        }
        .modal-btn:hover { background: #2563EB; }

        @media (max-width: 768px) {
            .container { margin: 10px; border-radius: 12px; }
            .header { padding: 30px 20px; }
            .header h1 { font-size: 2rem; }
            .content { padding: 30px 20px; }
        }
        @media (max-width: 480px) {
            .header h1 { font-size: 1.75rem; }
            .btn { width: 100%; padding: 14px; }
        }
    </style>
</head>
<body>

    <div class=""container"">
        <div class=""header"">
            <h1>‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ï‡∏≠‡∏ö‡πÅ‡∏ö‡∏ö‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°</h1>
        </div>
        <div class=""content"">
            <form id=""questionnaireForm"">
                <!-- Page 1: Participant Information -->
                <div id=""page1"" class=""page active"">
                     <div class=""instruction-box"">
                        <p>‡πÇ‡∏õ‡∏£‡∏î‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡∏≥‡∏ä‡∏µ‡πâ‡πÅ‡∏à‡∏á‡πÅ‡∏•‡∏∞‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏≥‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏ï‡πà‡∏≠‡πÑ‡∏õ ‡∏Ç‡∏≠‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡πà‡∏ß‡∏°‡∏°‡∏∑‡∏≠</p>
                    </div>
                    
                    <div id=""loader"" style=""text-align: center; padding: 2rem 0;"">
                        <div class=""spinner"" style=""margin: 0 auto;""></div>
                        <p style=""margin-top: 1rem; color: #6b7280;"">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡∏∞‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
                    </div>

                    <!-- ‡∏™‡πà‡∏ß‡∏ô Login ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Desktop -->
                    <div id=""loginSection"" style=""display: none; text-align: center; padding: 20px 0;"">
                        <h3 style=""margin-bottom: 16px;"">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h3>
                        <p style=""margin-bottom: 24px; color: #6B7280;"">‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö LINE ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô ‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡πÑ‡∏•‡∏ô‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ</p>
                        <button type=""button"" id=""lineLoginBtn"" class=""btn btn-line-login"">
                            ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢ LINE
                        </button>
                        <!-- ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏° Guest ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏£‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ User ID ‡∏à‡∏£‡∏¥‡∏á -->
                        <button type=""button"" id=""guestLoginBtn"" class=""btn btn-guest"" style=""font-size: 0.9em; display: none;"">
                            ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö (Guest Mode)
                        </button>
                    </div>

                    <div id=""participantSection"" style=""display: none;"">
                        <div class=""form-group"">
                            <label class=""form-label"" for=""participant"">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</label>
                            <div class=""dropdown"">
                                <select id=""participant"" name=""participant"" required>
                                    <option value="""" disabled selected>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà-‡∏¢‡∏®-‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</option>
                                </select>
                            </div>
                        </div>
                        <div id=""errorMessage"" style=""display: none; color: #EF4444; background: #FEF2F2; padding: 10px; border-radius: 6px; text-align: center; margin-bottom: 1rem; border: 1px solid #FECACA;"">
                            ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Å‡πà‡∏≠‡∏ô‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
                        </div>
                        <button type=""button"" id=""nextButton"" class=""btn btn-primary"">‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
                    </div>
                </div>

                <!-- Page 2: Questions -->
                <div id=""page2"" class=""page"">
                    <button type=""button"" id=""backButton"" class=""btn btn-back"">‚Üê ‡∏Å‡∏•‡∏±‡∏ö</button>
                    <div class=""problem-statement"">
                        <h3>‡∏Ñ‡∏≥‡∏ä‡∏µ‡πâ‡πÅ‡∏à‡∏á</h3>
                        <h4 id=""problem-lesson"" style=""font-weight: 500; margin-bottom: 1rem; color: #374151;""></h4>
                        <p id=""problem-description""></p>
                        <div class=""image-gallery"">
                            <div id=""img-container-1"" style=""display:none;""><img id=""image1"" src="""" alt=""‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà 1"" onerror=""this.style.display='none'""><p id=""image1-caption"" class=""image-caption""></p></div>
                            <div id=""img-container-2"" style=""display:none;""><img id=""image2"" src="""" alt=""‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà 2"" onerror=""this.style.display='none'""><p id=""image2-caption"" class=""image-caption""></p></div>
                            <div id=""img-container-3"" style=""display:none;""><img id=""image3"" src="""" alt=""‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà 3"" onerror=""this.style.display='none'""><p id=""image3-caption"" class=""image-caption""></p></div>
                        </div>
                    </div>
                    
                    <div class=""form-group""><label id=""question1-label"" for=""answer1"" class=""form-label""></label><textarea id=""answer1"" class=""textarea"" placeholder=""‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà...""></textarea></div>
                    <div class=""form-group""><label id=""question2-label"" for=""answer2"" class=""form-label""></label><textarea id=""answer2"" class=""textarea"" placeholder=""‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà...""></textarea></div>
                    <div class=""form-group""><label id=""question3-label"" for=""answer3"" class=""form-label""></label><textarea id=""answer3"" class=""textarea"" placeholder=""‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà...""></textarea></div>
                    <div class=""form-group""><label id=""question4-label"" for=""answer4"" class=""form-label""></label><textarea id=""answer4"" class=""textarea"" placeholder=""‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà...""></textarea></div>
                    <div class=""form-group""><label id=""question5-label"" for=""answer5"" class=""form-label""></label><textarea id=""answer5"" class=""textarea"" placeholder=""‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà...""></textarea></div>

                    <button type=""submit"" id=""submitButton"" class=""btn btn-success"">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Custom Modal -->
    <div id=""customModal"" class=""modal-overlay"">
        <div class=""modal-content"">
            <h3 id=""modalTitle"" class=""modal-title"">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</h3>
            <div id=""modalMessage"" class=""modal-message"">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</div>
            <button id=""modalBtn"" class=""modal-btn"">‡∏ï‡∏Å‡∏•‡∏á</button>
        </div>
    </div>

    <script>
        // Modal Helper
        const modal = document.getElementById('customModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const modalBtn = document.getElementById('modalBtn');

        function showModal(title, message, callback) {
            modalTitle.textContent = title;
            // Allow HTML in message for line breaks
            modalMessage.innerHTML = message;
            modal.classList.add('active');
            
            modalBtn.onclick = function() {
                modal.classList.remove('active');
                if (callback) callback();
            };
        }

        async function main() {
            // --- Elements ---
            const page1 = document.getElementById('page1');
            const page2 = document.getElementById('page2');
            const nextButton = document.getElementById('nextButton');
            const backButton = document.getElementById('backButton');
            const participantDropdown = document.getElementById('participant');
            const form = document.getElementById('questionnaireForm');
            const errorMessage = document.getElementById('errorMessage');
            const loader = document.getElementById('loader');
            const participantSection = document.getElementById('participantSection');
            const submitButton = document.getElementById('submitButton');
            
            // Login Elements
            const loginSection = document.getElementById('loginSection');
            const lineLoginBtn = document.getElementById('lineLoginBtn');
            const guestLoginBtn = document.getElementById('guestLoginBtn');

            // --- Configuration ---
            const LIFF_ID = '2008056238-g8p1R13n'; 
            const GAS_URL = 'https://script.google.com/macros/s/AKfycbzmdsVjgV-h_KFOCGpnt1HeZ1FdJTyMGKq9f4K0FALVR1iCd2ai-holzFH-4FTIqv6I/exec';
            const SHEET_ID = '1Fn3Rn8pO43tYOQrKI_-oSmc-UxL6hog3JXZ2cYjsGYI';
            const SHEET_GID = '1799873089';
            const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&gid=${SHEET_GID}`;
            
            let lineUserId = '';
            let sheetData = [];
            let isLiffMode = false;

            // --- Initialize LIFF Logic ---
            const initializeApp = async () => {
                try {
                    // Fetch Data first
                    await fetchSheetData();

                    if (typeof liff !== 'undefined') {
                        await liff.init({ liffId: LIFF_ID });
                        
                        // Case 1: Already Logged In
                        if (liff.isLoggedIn()) {
                            const profile = await liff.getProfile();
                            lineUserId = profile.userId;
                            isLiffMode = true;
                            showParticipantSection();
                        } 
                        // Case 2: Not Logged In
                        else {
                            loader.style.display = 'none';
                            loginSection.style.display = 'block';
                            
                            lineLoginBtn.onclick = () => {
                                // Redirect to LINE Login
                                if (!liff.isInClient()) {
                                    liff.login(); 
                                } else {
                                    liff.login();
                                }
                            };
                            
                            guestLoginBtn.onclick = () => {
                                lineUserId = 'GUEST-' + Math.floor(Math.random() * 100000);
                                showParticipantSection();
                            }
                        }
                    } else {
                        throw new Error(""LIFF SDK not loaded"");
                    }
                } catch (error) {
                    console.warn('LIFF Init failed or Error:', error);
                    lineUserId = 'WEB-ERROR-USER';
                    showParticipantSection();
                }
            };

            const showParticipantSection = () => {
                loader.style.display = 'none';
                loginSection.style.display = 'none';
                participantSection.style.display = 'block';
            };

            // --- Helper Function for Google Drive Links ---
            function convertGoogleDriveLink(url) {
                if (!url) return '';
                if (!url.includes('drive.google.com')) return url;
                const match = url.match(/drive\.google\.com.*[?&]id=([a-zA-Z0-9_-]+)|file\/d\/([a-zA-Z0-9_-]+)/);
                const fileId = match ? (match[1] || match[2]) : null;
                return fileId ? `https://lh3.googleusercontent.com/d/${fileId}` : '';
            }

            // --- Fetch and Process Google Sheet Data ---
            async function fetchSheetData() {
                try {
                    const response = await fetch(url);
                    const text = await response.text();
                    const jsonString = text.substring(47).slice(0, -2);
                    const json = JSON.parse(jsonString);
                    const rows = json.table.rows;

                    sheetData = rows.map(row => ({
                        A: row.c[0]?.v || '', B: row.c[1]?.v || '', C: row.c[2]?.v || '', D: row.c[3]?.v || '',
                        E: row.c[4]?.v || '', F: row.c[5]?.v || '', G: row.c[6]?.v || '', H: row.c[7]?.v || '',
                        I: row.c[8]?.v || '', J: row.c[9]?.v || '', K: row.c[10]?.v || '', L: row.c[11]?.v || '', M: row.c[12]?.v || '', N: row.c[13]?.v || '',
                    }));

                    // Populate Dropdown
                    let hasOptions = false;
                    sheetData.forEach((row, index) => {
                        if (row.A) { 
                            const option = document.createElement('option');
                            option.value = index;
                            option.textContent = row.A;
                            participantDropdown.appendChild(option);
                            hasOptions = true;
                        }
                    });
                    
                    if (!hasOptions) throw new Error(""No participants found"");

                } catch (error) {
                    console.error('Error fetching Google Sheet data:', error);
                    loader.innerHTML = `
                        <p style=""color: #EF4444; font-weight: bold;"">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
                        <button class=""btn btn-back"" onclick=""location.reload()"" style=""margin-top:10px;"">‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
                    `;
                }
            }
            
            // --- Update Page 2 Content ---
            function updateProblemContent(rowIndex) {
                const data = sheetData[rowIndex];
                if (!data) return;
                document.getElementById('problem-lesson').textContent = data.B ? `‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ä‡∏∏‡∏î‡∏ó‡∏µ‡πà ${data.B}` : '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠';
                document.getElementById('problem-description').textContent = data.C || '';
                
                // Handle Images
                const setupImage = (id, url, captionId, captionText, containerId) => {
                    const img = document.getElementById(id);
                    const container = document.getElementById(containerId);
                    const convertedUrl = convertGoogleDriveLink(url);
                    
                    if (convertedUrl) {
                        img.src = convertedUrl;
                        img.style.display = 'block';
                        container.style.display = 'block';
                        document.getElementById(captionId).textContent = captionText;
                    } else {
                        container.style.display = 'none';
                    }
                };

                setupImage('image1', data.D, 'image1-caption', data.E, 'img-container-1');
                setupImage('image2', data.F, 'image2-caption', data.G, 'img-container-2');
                setupImage('image3', data.H, 'image3-caption', data.I, 'img-container-3');

                document.getElementById('question1-label').textContent = data.J || '‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà 1';
                document.getElementById('question2-label').textContent = data.K || '‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà 2';
                document.getElementById('question3-label').textContent = data.L || '‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà 3';
                document.getElementById('question4-label').textContent = data.M || '‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà 4';
                document.getElementById('question5-label').textContent = data.N || '‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà 5';
            }

            // --- Navigation Logic ---
            nextButton.addEventListener('click', function() {
                const selectedIndex = participantDropdown.value;
                if (selectedIndex === """") {
                    errorMessage.style.display = 'block';
                    participantDropdown.parentElement.style.animation = ""shake 0.5s"";
                    setTimeout(() => participantDropdown.parentElement.style.animation = """", 500);
                } else {
                    errorMessage.style.display = 'none';
                    updateProblemContent(selectedIndex);
                    page1.classList.remove('active');
                    page2.classList.add('active');
                    window.scrollTo(0, 0);
                }
            });

            backButton.addEventListener('click', function() {
                page2.classList.remove('active');
                page1.classList.add('active');
                window.scrollTo(0, 0);
            });
            
            // --- Form Submission Logic (Smart Hybrid Mode) ---
            form.addEventListener('submit', async function(event) {
                event.preventDefault();
                submitButton.disabled = true;
                submitButton.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...';

                // --- 1. Gather Data ---
                const selectedOption = participantDropdown.options[participantDropdown.selectedIndex];
                const participantName = selectedOption ? selectedOption.textContent : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                const lesson = document.getElementById('problem-lesson').textContent;
                
                const questions = {
                    q1: document.getElementById('question1-label').textContent,
                    q2: document.getElementById('question2-label').textContent,
                    q3: document.getElementById('question3-label').textContent,
                    q4: document.getElementById('question4-label').textContent,
                    q5: document.getElementById('question5-label').textContent,
                };

                const answers = {
                    a1: document.getElementById('answer1').value.trim() || '-',
                    a2: document.getElementById('answer2').value.trim() || '-',
                    a3: document.getElementById('answer3').value.trim() || '-',
                    a4: document.getElementById('answer4').value.trim() || '-',
                    a5: document.getElementById('answer5').value.trim() || '-',
                };
                
                // Prepare Message
                const summaryMessage = `üìù ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡πÅ‡∏ö‡∏ö‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°
-------------------------
‡∏ú‡∏π‡πâ‡∏ï‡∏≠‡∏ö: ${participantName}
User ID: ${lineUserId.startsWith('GUEST') ? 'Guest' : lineUserId.substring(0, 5) + '...'}
‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ä‡∏∏‡∏î‡∏ó‡∏µ‡πà: ${lesson}
-------------------------
1. ${questions.q1}
‡∏ï‡∏≠‡∏ö: ${answers.a1}

2. ${questions.q2}
‡∏ï‡∏≠‡∏ö: ${answers.a2}

3. ${questions.q3}
‡∏ï‡∏≠‡∏ö: ${answers.a3}

4. ${questions.q4}
‡∏ï‡∏≠‡∏ö: ${answers.a4}

5. ${questions.q5}
‡∏ï‡∏≠‡∏ö: ${answers.a5}
-------------------------
‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏£‡πà‡∏ß‡∏°‡∏ï‡∏≠‡∏ö‡πÅ‡∏ö‡∏ö‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°`;

                // --- 2. Send to GAS ---
                try {
                    const formData = new FormData();
                    formData.append('timestamp', new Date().toLocaleString('th-TH', { timeZone: 'Asia/Bangkok' }));
                    formData.append('lineUserId', lineUserId);
                    formData.append('participant', participantName);
                    formData.append('lesson', lesson);
                    formData.append('q1', questions.q1); formData.append('a1', answers.a1);
                    formData.append('q2', questions.q2); formData.append('a2', answers.a2);
                    formData.append('q3', questions.q3); formData.append('a3', answers.a3);
                    formData.append('q4', questions.q4); formData.append('a4', answers.a4);
                    formData.append('q5', questions.q5); formData.append('a5', answers.a5);
                    
                    // *** Smart Switch Logic ***
                    // ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÅ‡∏≠‡∏õ LINE (Mobile): ‡∏™‡πà‡∏á 'false' ‡πÑ‡∏õ‡∏ó‡∏µ‡πà GAS (‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ GAS ‡∏¢‡∏¥‡∏á Push) -> ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÉ‡∏ä‡πâ liff.sendMessages ‡∏¢‡∏¥‡∏á‡πÄ‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô User Message
                    // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÅ‡∏≠‡∏õ LINE (Desktop): ‡∏™‡πà‡∏á 'true' ‡πÑ‡∏õ‡∏ó‡∏µ‡πà GAS (‡πÉ‡∏´‡πâ GAS ‡∏¢‡∏¥‡∏á Push) -> ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏£‡∏≤‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ô‡∏≠‡∏Å‡∏à‡∏≤‡∏Å Push
                    const isLineApp = liff.isInClient();
                    formData.append('pushMessage', isLineApp ? 'false' : 'true');
                    formData.append('messageContent', summaryMessage);

                    const response = await fetch(GAS_URL, {
                        method: 'POST',
                        body: formData,
                    });
                    
                    const result = await response.json();

                    if (result.result !== 'success') {
                         throw new Error('Script returned non-success result');
                    }

                    // --- 3. Success Handling (Hybrid) ---
                    
                    if (isLineApp) {
                        // Case A: Mobile LINE App -> ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ö‡∏ö User (‡∏ù‡∏±‡πà‡∏á‡∏Ç‡∏ß‡∏≤)
                        try {
                            await liff.sendMessages([{ type: 'text', text: summaryMessage }]);
                            liff.closeWindow();
                        } catch (msgError) {
                            console.error(""LIFF Send Error:"", msgError);
                            // ‡∏ñ‡πâ‡∏≤‡∏™‡πà‡∏á‡πÅ‡∏ö‡∏ö User ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô (‡πÄ‡∏ä‡πà‡∏ô user ‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏ö‡∏≠‡∏ó ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÑ‡∏°‡πà‡∏û‡∏≠)
                            // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á
                            liff.closeWindow();
                        }
                    } else {
                        // Case B: Desktop Browser -> ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡∏• Push Message ‡∏à‡∏≤‡∏Å Server (‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢)
                        let modalTitleText = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
                        let modalBodyText = '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤ LINE ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß';
                        let isSuccess = true;

                        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ lineApiStatus ‡∏à‡∏≤‡∏Å GAS
                        if (result.lineApiStatus && result.lineApiStatus !== 'Success' && result.lineApiStatus !== 'skipped') {
                            modalTitleText = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß (‡πÅ‡∏ï‡πà‡∏™‡πà‡∏á LINE ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô)';
                            let errorMsg = result.lineApiStatus;
                            let fixSuggestion = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Channel Access Token ‡πÉ‡∏ô Google Apps Script';

                            if (errorMsg.includes(""UrlFetchApp"") || errorMsg.includes(""script.external_request"")) {
                                fixSuggestion = '<strong>‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç:</strong> ‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≠‡∏Å‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å<br>1. ‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Google Apps Script<br>2. ‡∏•‡∏≠‡∏á‡∏Å‡∏î Run ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô pushLineMessage (‡∏´‡∏£‡∏∑‡∏≠ doPost)<br>3. ‡∏Å‡∏î‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå (Review Permissions)<br>4. Deploy ‡πÉ‡∏´‡∏°‡πà (New Deployment)';
                            }

                            modalBodyText = `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á Sheet ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÅ‡∏ï‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° LINE:<br><br><code style=""color:red; background:#fee; padding:2px 4px; border-radius:4px; display:block; margin-bottom:10px;"">${errorMsg}</code><br>${fixSuggestion}`;
                            isSuccess = false;
                        }

                        showModal(modalTitleText, modalBodyText, () => {
                            location.reload();
                        });
                    }
                    
                } catch (error) {
                    console.error('Submission Error:', error);
                    showModal('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ ‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
                    submitButton.disabled = false;
                    submitButton.textContent = '‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö';
                }
            });

            // Start App
            initializeApp();
        }

        document.addEventListener('DOMContentLoaded', main);
    </script>
</body>
</html>"
